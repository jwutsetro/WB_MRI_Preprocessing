input_dir: /path/to/raw_dicoms
output_dir: /path/to/processed
working_dir: work
target_orientation: LPS

dicom_rules_path: dicom_config.json

steps:
  # You can also set `steps: [dicom_sort, adc, noise_bias, isis]` to mean "only these steps".
  dicom_sort: true
  adc: true
  noise_bias: true
  isis: false
  registration: false
  reconstruct: false
  resample_to_t1: false

# Bias correction + body masking
noise_bias:
  # Anatomical: per-volume N4 bias correction with an explicit body mask.
  apply_to_anatomical: true
  # DWI: estimate bias from the lowest-b (typically b0) volume per station and apply to all b-values.
  apply_to_dwi: true
  dwi_reference: lowest_b  # or "b0" (only if a b=0 directory exists)
  save_masks: true
  mask_dir_name: _masks
  apply_body_mask: true

  # Mask construction (used for N4 + optional background zeroing).
  mask_smoothing_sigma: 1.0
  mask_closing_radius: 1
  mask_dilation_radius: 1

  # N4 settings; shrink factors trade a little accuracy for big speedups.
  n4_shrink_factor_anatomical: 2
  n4_shrink_factor_dwi: 4
  n4_max_iterations: [50, 50, 30, 20]
  n4_convergence_threshold: 1.0e-4

# Dataset-level standardisation (run separately via `python -m Preprocessing nyul --config ...`)
nyul:
  enable: true
  bins: 120
  landmarks: 6
  upper_outlier: 99.5
  remove_bg_below: 5.0
  model_dir: models
  modalities:
    - T1
    - ADC
  refresh: false
